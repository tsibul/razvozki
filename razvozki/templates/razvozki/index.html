
{% extends 'razvozki/main.html' %}
{% block title %}Развозки{% endblock %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
{% block content %}
{% load static %}

<div id="page_number" hidden>{{page_number}}</div>
<div class="pagination" xmlns="http://www.w3.org/1999/html">
    <span class="step-links">
        {% if page_obj.has_previous %}
            <a href="?page=1" class="btn btn-outline-success fw-bold">&laquo; первая</a>
            <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-outline-success fw-bold">предыдущая</a>
        {% endif %}
        <span class="current btn btn-outline-secondary fw-bold">
           {{ page_obj.object_list.7.0|date:"d.m.y" }} - {{ page_obj.object_list.0.0|date:"d.m.y" }} (страница {{ page_obj.number }}  из {{ page_obj.paginator.num_pages }})
        </span>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="btn btn-outline-success fw-bold">следующая</a>
            <a href="?page={{ page_obj.paginator.num_pages }}" class="btn btn-outline-success fw-bold">последняя &raquo;</a>
        {% endif %}
        &nbsp
            <button class="btn btn-outline-success dropdown-toggle fw-bold" type="button" id="_ChooseClientAdd{{rzv.id}}"
                    data-bs-toggle="dropdown"  aria-haspopup="true" aria-expanded="false">
                Выбрать даты
            </button>
              <ul class="dropdown-menu fw-bold" aria-labelledby="ChooseClientAdd{{rzv.id}}">
                {% for dt_range in date_range %}
              <li><a class="dropdown-item" href="?page={{ dt_range.0 }}"> {{ dt_range.1 }}</a></li>
                {% endfor %}
              </ul>

    </span>
</div><!-- pagination -->
<br>

{% if page_number == '1' or page_number == None or page_number == '2' %}
<form class="row g-1" action="newdate_rzv" method="post">
{% csrf_token %}
<div class="col-1">
      <li class="form-control-plaintext fw-bold"> Новая дата</li>
</div>
<div class="col-auto align-middle p-1">
<input type="date"  name="date" value="{{ datenew }}">
</div>
  <div class="col-auto">
    <button type="submit" class="btn btn-success mb-1">Создать</button>
  </div>
</form>
{% endif %}

<table class="table table-hover table-border border-success">
{% for date_r, razv in f_rzv.items %}
    <thead>
    <tr class="table-success">
        <th scope="col" colspan="2" class="">
        {% if date_r|date:'Y-m-d' >= dateold %}
        <a href="javascript:add_ln2('{{date_r|date:'Y-m-d'}}');">
            <button class="btn btn-sm btn-outline-success fw-bold" data-toggle="tooltip"
                    data-placement="top" title="добавить развозку">
            <div class="fw-normal">добавить развозку</div>
            </button></a>
        {% endif %}
        </th>
        {% if date_r|date:'Y-m-d' != '2100-01-01' %}
<!--            <th scope="col" colspan="1" class="text-nowrap text-end"> развозка на </th> <--->
            <th scope="col" colspan="1" class="text-nowrap text-start"
                onclick="javascript:colapse('date_{{date_r|date:'Y-m-d' }}');">Развозка на {{ date_r|date:"d.m.Y" }}</th>
            <form action="print_rzv/{{ date_r|date:'Y-m-d'}}" method="post">
            {% csrf_token %}
            <th scope="col" class="text-start"> <button type="submit" class="btn btn-outline-success btn-sm fw-bold" formtarget="_blank">
                <i class="bi bi-printer-fill" style="currentColor"></i> Печать</button>
            </th>
            </form>
        {% else %}
            <th scope="col" colspan="1" class="text-nowrap text-start"
                onclick="javascript:colapse('date_{{date_r|date:'Y-m-d' }}');"> Развозки планируемые </th>
            <th></th>
        {% endif %}

        <th scope="col" class="text-danger">
        {% for rzv in rzv_len %}
        {% if date_r == rzv.0 %}
            <div class="fw-normal"> развозок: {{rzv.1}}</div>
        {% endif %}
        {% endfor %}

        </th>
        <th scope="col" class="text-end">
        <a href="javascript:colapse('date_{{date_r|date:'Y-m-d' }}');" id="collapse_date_{{date_r|date:'Y-m-d'}}_but">
        <button type=button class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-bars"></i>
        </button></a>
        </th>
    </tr>

    </thead>
    {% if date_r|date:'Y-m-d' != '2100-01-01' %}
    <tbody id="collapse_date_{{date_r|date:'Y-m-d'}}" style="display:table-row-group;">
    {% else %}
    <tbody id="collapse_date_{{date_r|date:'Y-m-d'}}" style="display:none;">
    {% endif %}
<!--            onmouseover="this.style.backgroundColor='#eee';" onmouseout="this.style.backgroundColor='#ffffff';"><--->


    <tr class="dropdown" id="cst_id4_{{date_r|date:'Y-m-d'}}" style="display:none">
        <td></td>
<!--        <td colspan="2">
      </td><--->
    </tr>

    <tr id="cst_id5_{{date_r|date:'Y-m-d'}}" style="display:none" data-placement="middle">
    <form action="addrecord_razv/" method="post" id="cst_id8_{{date_r|date:'Y-m-d'}}">
    {% csrf_token %}
     <input type="hidden" id="page_number_add" name="page_number_add" value="{{ page_obj.number }}"
            form="cst_id8_{{date_r|date:'Y-m-d'}}">
        <td>
        <input type="text" style="max-width:40px;" class="form-control" placeholder="#"
           name="date_id" value="0" form="cst_id8_{{date_r|date:'Y-m-d'}}">
        </td>
        <td class="dropdown p-1">
        <div id="dropdown_id_{{date_r|date:'Y-m-d'}}">
        </div>
        {%  if date_r|date:'Y-m-d' == '2100-01-01' %}
        <br><br>
        <div style="font-size:80%;">
         <label for="date_until{{date_r}}">срок до</label>
         <input type="date" name="date_until" class="form-control"  value="{{datenew}}"
                id="date_until{{date_r}}" form="cst_id8_{{date_r|date:'Y-m-d'}}">
        </div>
        {% endif %}
        </td>
        <td colspan="3"><div class="row p-1">
            <input type="hidden" name="date" value="{{date_r}}">
            <div class="col">
            <input type="hidden" id="updcust_id_{{date_r|date:'Y-m-d'}}" name="customer" value=None>
            <textarea id="updcust_name_{{date_r|date:'Y-m-d'}}" class="form-control" placeholder="Клиент"  name="customer_name"></textarea>
            </div>
            <div class="col">
            <textarea id="updcust_address_{{date_r|date:'Y-m-d'}}" class="form-control" placeholder="Адрес" name="address"></textarea>
            </div>
            <div class="col">
            <textarea id="updcust_contact_{{date_r|date:'Y-m-d'}}" class="form-control" placeholder="Контакт" name="contact"></textarea>
            </div>
        </div>
        <div class="row p-1">
            <div class="col" style="min-width:480px">
            <textarea class="form-control" placeholder="Забрать" name="to_do_take" id="to_do_take_{{date_r|date:'Y-m-d'}}"></textarea>
            </div>
            <div class="col">
                <button type="button" class="btn btn-sm btn-outline-danger dropdown-toggle" data-bs-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false" id="Choosereturn{{date_r|date:'Y-m-d'}}"><i class="bi bi-arrow-return-left">
                </i>возврат</button>
                <ul class="dropdown-menu" aria-labelledby="Choosereturn{{date_r|date:'Y-m-d'}}" id="ul_{{date_r|date:'Y-m-d'}}">
                </ul>
                <input style="font-size:80%;" type="text" name="return_goods" class="form-control" value=""
                       readonly form="cst_id8_{{date_r|date:'Y-m-d'}}" id="r_date_{{date_r|date:'Y-m-d'}}" >
                <input type="text" hidden id="r_id_{{date_r|date:'Y-m-d'}}" name="r_id"
                        form="cst_id8_{{date_r|date:'Y-m-d'}}">
            </div>
            <div class="col" style="min-width:480px">
            <textarea class="form-control" placeholder="Сдать" name="to_do_deliver"></textarea>
            </div>
            <div class="col p-1 text-end align-center" hidden>
            <input type="checkbox" class="btn-check" id="btn_checked_{{rzv.id}}" autocomplete="off"
                   value="0" onclick="javascript:f_deliver_to({{rzv.id}});">
            <label class="btn btn-sm btn-outline-danger" for="btn_checked_{{rzv.id}}" >
                <i class="bi bi-arrow-repeat"></i>&nbsp;на переработку</label>
            </div>
        </div></td>
        <td class="align-middle">
            <a href="javascript:add_ln2_reverse('{{date_r|date:'Y-m-d'}}');">
            <button type="button" class="btn btn-sm btn-outline-danger" data-toggle="tooltip"
                    data-placement="top" title="отменить">
                <i class="bi bi-arrow-counterclockwise"></i>
            </button>
            </a>
            <br><br>
            <button type="submit" class="btn btn-sm btn-outline-success" data-toggle="tooltip"
                    data-placement="bottom" title="записать">
                <i class="bi bi-check-lg"></i>
            </button>
        </td>
    </form>
    </tr>



    {% for rzv in razv %}

    <form action="updaterecord_rzv/{{ rzv.id }}" method="post" id="updaterecord_rzv_{{rzv.id}}">
        {% csrf_token %}
        <td id="date_{{rzv.id}}" hidden>{{rzv.date|date:'Y-m-d'}}</td>
        <td id="map_point_{{rzv.id}}" hidden>{{rzv.map_point}}</td>
        <td id="customer_{{rzv.id}}" hidden>{{rzv.customer.id}}</td>
        <input type="text" id="return_from_{{rzv.id}}" hidden value="{{rzv.return_from}}">

        <tr id="cst_id_{{rzv.id}}" class="lh-1 align-top" >
        {% if date_r|date:'Y-m-d' != '2100-01-01' %}
            <td id="rzv_id_{{rzv.id}}">{{ rzv.date_id }}</td>
        {% else %}
            <td></td>
            <td id="rzv_id_{{rzv.id}}" hidden>{{ rzv.date_id }}</td>
        {% endif %}
            <td class="text-unwrap" style="min-width:140px;">
            {% if rzv.date|date:'Y-m-d' != '2100-01-01' %}
            <div class="col p-1" id="rzv_fulfilled_{{rzv.id}}" >
            {% if rzv.fulfilled %}
            <button class="btn btn-sm btn-outline-success" type="button" id="rzv_fulfilled_but_{{rzv.id}}"
                    onclick="javascript:rzv_status({{rzv.id}});" name="1">
                <i class="bi bi-check2"></i>выполнено
            </button>
            {% else %}
            <button class="btn btn-sm btn-outline-danger" type="button" id="rzv_fulfilled_but_{{rzv.id}}"
                    onclick="javascript:rzv_status({{rzv.id}});" name="0">
                <i class="bi bi-hourglass"></i>в процессе
            </button >
            {% endif %}
            </div>
                       <div class="col p-1" id="razv_return_all_{{rzv.id}}">
            {% if rzv.return_from %}
            {% if rzv.return_goods.return_all %}
            <button class="btn btn-sm btn-outline-success" type="button" id="rzv_return_all_{{rzv.id}}"
                    onclick="javascript:rzv_return_all({{rzv.id}}, {{rzv.return_goods.id}});" name="1">
                <i class="fa-regular fa-handshake"></i>полностью
            </button>
            {% else %}
            <button class="btn btn-sm btn-outline-danger" type="button" id="rzv_return_all_{{rzv.id}}"
                    onclick="javascript:rzv_return_all({{rzv.id}}, {{rzv.return_goods.id}});" name="0">
                <i class="fas fa-person-digging"></i>&nbsp;&nbsp;  частично
            </button >
            {% endif %}
            {% endif %}
            </div>
            {% else %}
            <div class="col p-1" id="date_create_{{rzv.id}}" >от {{rzv.date_create|date:'d.m.Y'}}</div>
            <br>
            <div class="col p-1" id="date_until_{{rzv.id}}" >до {{rzv.date_until|date:'d.m.Y'}}</div>
            <input name="0" hidden type="text" id="rzv_fulfilled_but_{{rzv.id}}" value="{{rzv.fulfilled}}">
            <input type="text" hidden id="date_create2_{{rzv.id}}" value="{{rzv.date_create|date:'Y-m-d'}}">
            <input type="text" hidden id="date_until2_{{rzv.id}}" value="{{rzv.date_until|date:'Y-m-d'}}">

            {% endif %}

            </td>
            <td colspan="3">

            <div class="row" onclick="javascript:upd_rzv({{rzv.id}});" >
            <div class="col p-1" id="customer_name_{{rzv.id}}"
                 >{{ rzv.customer_name }}</div>
            <div class="col p-1" id="address_{{rzv.id}}"
                 >{{ rzv.address }}</div>
            <div class="col p-1" id="contact_{{rzv.id}}"
                 >{{ rzv.contact }}</div>
            </div>
            <div class="row text-success border border-success mt-2 pt-2 pb-1 bg-light align-self-bottom" style="font-size:100%" >
            {% if rzv.to_do_take != '' %}
            <div class="col" id="to_do_take_{{rzv.id}}"><strong>ЗАБРАТЬ:</strong> {{rzv.to_do_take}}</div>
            {% if rzv.return_from %}
            <div class="col p-1" >
                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#rzv_return{{rzv.id}}">
                    c переработки {{rzv.return_goods.date|date:'d.m.Y'}}</button>
            </div>
            <!-- Modal -->
            <div class="modal fade" id="rzv_return{{rzv.id}}" tabindex="-1" aria-labelledby="rzv_return{{rzv.id}}Label" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="rzv_return{{rzv.id}}Label">Что отвозили</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                      <div> дата: {{rzv.return_goods.date|date:'d.m.Y'}},
                            кому: {{rzv.return_goods.customer_name}}</div>
                      <br>
                      <h6>{{rzv.return_goods.to_do_deliver}}</h6>
                  </div>
                </div>
              </div>
            </div>
            <input type="text" hidden id="return_goods_id_{{rzv.id}}" value="{{rzv.return_goods.id}}">
            <input type="text" hidden id="return_goods_{{rzv.id}}" value="{{rzv.return_goods.date|date:'d.m.Y'}}">
            <input type="text" hidden id="return_goods_customer_name_{{rzv.id}}" value="{{rzv.return_goods.customer_name}}">
            <input type="text" hidden id="return_goods_to_do_take_{{rzv.id}}" value="{{rzv.return_goods.to_do_deliver}}">

            {% endif %}
            {% endif %}

            {% if rzv.to_do_deliver != '' %}
                <div class="col" id="to_do_deliver_{{rzv.id}}"
                 onclick="javascript:upd_rzv({{rzv.id}});"
                     style="min-width:420px;"> <strong> СДАТЬ:</strong> {{rzv.to_do_deliver}} </div>
                {% if rzv.deliver_to %}
                    {% if rzv.return_all %}
                    <div class="col p-1 text-end align-center" >
                    <input type="checkbox" class="btn-check" id="btn_checked_{{rzv.id}}" autocomplete="off" disabled
                           value="1" checked onclick="javascript:f_deliver_to({{rzv.id}});">
                    <label class="btn btn-sm btn-outline-danger" for="btn_checked_{{rzv.id}}" >
                        <i class="bi bi-arrow-repeat"></i>&nbsp;на переработку</label>
                    </div>
                    {% else %}
                    <div class="col p-1 text-end align-center" >
                    <input type="checkbox" class="btn-check" id="btn_checked_{{rzv.id}}" autocomplete="off"
                           value="1" checked onclick="javascript:f_deliver_to({{rzv.id}});">
                    <label class="btn btn-sm btn-outline-danger" for="btn_checked_{{rzv.id}}" >
                        <i class="bi bi-arrow-repeat"></i>&nbsp;на переработку</label>
                    </div>
                    {% endif %}
                {% else %}
                <div class="col p-1 text-end align-center" >
                <input type="checkbox" class="btn-check" id="btn_checked_{{rzv.id}}" autocomplete="off"
                       value="0" onclick="javascript:f_deliver_to({{rzv.id}});">
                <label class="btn btn-sm btn-outline-danger" for="btn_checked_{{rzv.id}}">
                    <i class="bi bi-arrow-repeat"></i>&nbsp;на переработку</label>
                </div>
                {% endif %}
            {% endif %}

            </div>
            </td>
            <td class="text-end" id="rzv_delete_{{rzv.id}}">
                {% if rzv.fulfilled %}
                <button class="btn btn-sm btn-outline-danger fw-bold" data-toggle="tooltip" data-placement="top"
                    title="удалить развозку" disabled><i class="bi bi-x-lg"></i></button>
                {% else %}
                <a href="delete_rzv/{{ rzv.id }}">
                <button type="button" class="btn btn-sm btn-outline-danger fw-bold" data-toggle="tooltip" data-placement="top"
                    title="удалить развозку"><i class="bi bi-x-lg"></i></button>
                </a>
                {% endif %}
            </td>
        </tr>
        <!-- First row show -->
    </form>
    {% endfor %}
    </tbody>
{% endfor %}
</table>


<!--        <th scope="row" id="cst_id2_{{rzv.id}}" style="display:none">
        </th>
        <form action="updaterecord_rzv/{{ rzv.id }}" method="post">
        {% csrf_token %}
        <tr id="cst_id3_{{rzv.id}}" style="display:none">
            <input type="hidden" id="page_number_upd" name="page_number_upd" value="{{ page_obj.number }}">
            <input id="updcust_id_{{rzv.id}}_"  type="hidden" name="customer" value=None>
            <td colspan=1">
                <a href="javascript:upd_ln2_reverse({{rzv.id}});">
                    <button type="button" class="btn btn-sm btn-outline-danger"
                                  data-toggle="tooltip" data-placement="top" title="отменить">
                        <i class="fa fa-undo"></i>
                    </button>
                </a>
            </td>
            <td colspan="1" style="max-width:10px;"> <input type="number" class="form-control" id="date_id" placeholder="#" name="date_id" value="{{ rzv.date_id }}"> </td>
            <td colspan="1">
            {% if rzv.customer is None %}
                <input type="text" class="form-control " id="customer_name" placeholder="Клиент" name="customer_name" value="{{ rzv.customer_name }}">
            {% else %}
                <p type="text" class="form-control  bg-light">{{ rzv.customer_name }}</p>
            {% endif %}
                <p type="date"  class="text-center"><input type="date"  name="date" value="{{ rzv.date|date:'Y-m-d' }}"></p>
            </td>
            <td colspan="1"><textarea class="form-control  " id="address" placeholder="Адрес" name="address"> {{ rzv.address }} </textarea></td>
            <td colspan="1"><textarea class="form-control  " id="contact" placeholder="Контакт" name="contact"> {{ rzv.contact }}</textarea></td>
            <td colspan="1">
            <p>
                <input type="text" class="form-control  {{rzv.clr}}" id="to_do_take" placeholder="Забрать" name="to_do_take" value="{{ rzv.to_do_take }}">
            </p>
                <input type="text" class="form-control " id="to_do_deliver" placeholder="Сдать" name="to_do_deliver" value="{{ rzv.to_do_deliver }}">
            </td>
            <td colspan="1"> <button type="submit" class="btn btn-sm btn-outline-success" data-toggle="tooltip" data-placement="bottom">
                <i class="fa fa-check"></i></button></td>
        </tr>
        </form> <--->
<!--       <tr>
                <th scope="row"></th>
                <td  style="width:30px" class="text-dark"><input type="number" class="form-control" disabled value="{{ rzv.date_id }}"></a></td>
                <td class="text-dark">{{ rzv.customer_name }}</td>
                <td class="text-dark">{{ rzv.address }}</td>
                <td class="text-dark">{{ rzv.contact }}</td>
                <td class="text-dark">{{ rzv.get_all_todo }}</td>
                <td class="text-dark"></td>
            </tr>

     <--->




<div class="pagination">
    <span class="step-links">
        {% if page_obj.has_previous %}
            <a href="?page=1" class="btn btn-outline-success fw-bold">&laquo; первая</a>
            <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-outline-success fw-bold">предыдущая</a>
        {% endif %}

        <span class="current btn btn-outline-secondary fw-bold">
           {{ page_obj.object_list.7.0|date:"d.m.y" }} - {{ page_obj.object_list.0.0|date:"d.m.y" }} (страница {{ page_obj.number }}  из {{ page_obj.paginator.num_pages }})
        </span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="btn btn-outline-success fw-bold">следующая</a>
            <a href="?page={{ page_obj.paginator.num_pages }}" class="btn btn-outline-success fw-bold">последняя &raquo;</a>
        {% endif %}
    </span>
</div><!-- pagination -->


<!--<script src="{% static 'razvozki/bootstrap.bundle.min.js' %}" crossorigin="anonymous"></script><--->
<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
<--->

{% endblock %}